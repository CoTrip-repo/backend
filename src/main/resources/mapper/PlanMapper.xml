<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.cotrip.api.plan.repository.PlanMapper">

    <insert id="insert" parameterType="Plan" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO plans (code, title, start_date, end_date, budget, leader_id)
        VALUES (#{code}, #{title}, #{startDate}, #{endDate}, #{budget}, #{leaderId})
    </insert>

    <update id="update">
        UPDATE plans
        SET title = #{title},
            start_date = #{startDate},
            end_date = #{endDate},
            budget = #{budget},
            updated_at = NOW()
        WHERE id = #{planId}
          AND deleted_at IS NULL
    </update>

    <update id="delete" parameterType="Long">
        UPDATE plans
        SET deleted_at = NOW()
        WHERE id = #{planId}
          AND deleted_at IS NULL
    </update>

    <select id="findByPlanId" resultType="Plan">
        SELECT *
        FROM plans
        WHERE id = #{planId}
          AND deleted_at IS NULL
    </select>

    <select id="findByUserId" resultType="Plan">
        SELECT p.*
        FROM plans p
        INNER JOIN plan_participants pp ON p.id = pp.plan_id
        WHERE pp.user_id = #{userId}
          AND p.deleted_at IS NULL
          AND pp.deleted_at IS NULL
        ORDER BY p.created_at DESC
    </select>

    <select id="findByUserIdWithCursor" resultType="Plan" parameterType="map">
        SELECT p.*
        FROM plans p
        INNER JOIN plan_participants pp ON p.id = pp.plan_id
        <where>
            pp.user_id = #{userId}
            AND p.deleted_at IS NULL
            AND pp.deleted_at IS NULL
            <if test="cursorId != null">
                AND p.id &lt; #{cursorId}
            </if>
        </where>
        ORDER BY p.id DESC
        LIMIT #{size}
    </select>

    <select id="getPlanParticipantCount" resultType="int">
        SELECT COUNT(*)
        FROM plan_participants
        WHERE plan_id = #{planId}
          AND deleted_at IS NULL
    </select>

    <select id="findByCode" resultType="Plan">
        SELECT *
        FROM plans
        WHERE code = #{code}
          AND deleted_at IS NULL
    </select>

</mapper>
